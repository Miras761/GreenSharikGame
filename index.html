<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Green Ball Jump — Игра</title>
  <style>
    :root{--bg:#06130a;--panel:#0f281f;--accent:#2ad27a;--muted:#8fbca3;}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif;background:linear-gradient(180deg,var(--bg),#02220f);color:#e6fff2}
    .wrap{display:flex;flex-direction:column;gap:12px;align-items:center;padding:14px}
    header{width:100%;max-width:900px;display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:18px;color:var(--accent)}
    .hud{display:flex;gap:10px;align-items:center}
    .btn{background:var(--panel);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    canvas{background:linear-gradient(180deg,#0b2a19,#052015);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);max-width:100%;width:900px;height:500px}
    .controls{display:flex;gap:8px;align-items:center}
    .info{font-size:14px;color:var(--muted)}
    .bottom-row{display:flex;gap:10px;align-items:center;width:100%;max-width:900px;justify-content:space-between}
    /* shop modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(rgba(0,0,0,0.45),rgba(0,0,0,0.6));backdrop-filter:blur(2px);}
    .card{background:var(--panel);border-radius:12px;padding:14px;width:320px;color:var(--muted);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .skin{display:flex;gap:10px;align-items:center;margin:8px 0}
    .skin .swatch{width:48px;height:48px;border-radius:50%;border:2px solid rgba(255,255,255,0.04)}
    .skin button{margin-left:auto}
    .virt-btn{position:fixed;right:18px;bottom:18px;background:var(--accent);border:none;padding:18px;border-radius:50%;box-shadow:0 8px 20px rgba(0,0,0,0.5);display:none}
    /* responsive */
    @media (max-width:950px){canvas{width:100%;height:60vh} .virt-btn{display:block}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Green Ball Jump</h1>
      <div class="hud">
        <div class="info">Монеты: <span id="coins">0</span></div>
        <div class="info">Жизни: <span id="lives">1</span></div>
        <button class="btn" id="shopBtn">Магазин</button>
      </div>
    </header>

    <canvas id="game" width="900" height="500"></canvas>

    <div class="bottom-row">
      <div class="info">Управление: пробел или тап (мобильные устройства). Монета дается за каждое прыжок.</div>
      <div>
        <button class="btn" id="restart">Перезапустить</button>
        <button class="btn" id="mute">Звук: вкл</button>
      </div>
    </div>
  </div>

  <button class="virt-btn" id="tapBtn">Прыжок</button>

  <!-- Shop Modal (hidden by default) -->
  <div id="shopModal" class="modal" style="display:none">
    <div class="card">
      <h3 style="margin-top:0;color:var(--accent)">Магазин скинов</h3>
      <div id="skinsList"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div class="info">Выбранный: <span id="selectedSkinName">Белый</span></div>
        <button class="btn" id="closeShop">Закрыть</button>
      </div>
    </div>
  </div>

<script>
// ----- Game variables -----
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;
let gravity = 0.9;
let groundY = H - 60;
let running = true;
let lives = 1;
let coins = Number(localStorage.getItem('gg_coins')||0);
let ownedSkins = JSON.parse(localStorage.getItem('gg_ownedSkins')||'["white"]');
let selectedSkin = localStorage.getItem('gg_selectedSkin')||'white';

// UI
const coinsEl = document.getElementById('coins');
const livesEl = document.getElementById('lives');
const shopBtn = document.getElementById('shopBtn');
const shopModal = document.getElementById('shopModal');
const skinsList = document.getElementById('skinsList');
const closeShop = document.getElementById('closeShop');
const selectedSkinName = document.getElementById('selectedSkinName');
const restartBtn = document.getElementById('restart');
const muteBtn = document.getElementById('mute');
const tapBtn = document.getElementById('tapBtn');

let soundOn = true;
function playBeep(){ if(!soundOn) return; try{ const o=new Audio(); o.src='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA='; o.play().catch(()=>{}); }catch(e){}
}

// Skins definition
const skins = [
  {id:'white', name:'Белый', cost:0, color:'#ffffff'},
  {id:'green', name:'Зелёный', cost:50, color:'#2ad27a'},
  {id:'blue', name:'Синий', cost:120, color:'#3aa6ff'},
  {id:'gold', name:'Золотой', cost:300, color:'#ffd166'}
];

function saveState(){ localStorage.setItem('gg_coins', String(coins)); localStorage.setItem('gg_ownedSkins', JSON.stringify(ownedSkins)); localStorage.setItem('gg_selectedSkin', selectedSkin);} 

function updateHUD(){ coinsEl.textContent = coins; livesEl.textContent = lives; selectedSkinName.textContent = skins.find(s=>s.id===selectedSkin)?.name||'Белый'; }

// ----- Player -----
const player = { x:120, y:groundY - 24, r:20, vy:0, onGround:true, alive:true };

function resetGame(){ player.x=120; player.y=groundY-24; player.vy=0; player.onGround=true; player.alive=true; lives=1; obstacles=[]; score=0; running=true; updateHUD(); }

// ----- Obstacles -----
let obstacles = [];
let obstacleTimer = 0;
let obstacleInterval = 120; // frames
let score = 0;

function spawnObstacle(){ const h = 30 + Math.random()*60; const w = 20 + Math.random()*50; obstacles.push({x:W + 40, y:groundY - h, w:w, h:h, speed:4 + Math.random()*2}); }

// ----- Controls -----
function jump(){ if(!player.alive) return; if(player.vy < -2) return; // small limit to avoid multi-jump exploit
 player.vy = -14; player.onGround=false; coins += 1; saveState(); updateHUD(); playBeep(); }

document.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); jump(); } });
canvas.addEventListener('touchstart', e=>{ e.preventDefault(); jump(); });
canvas.addEventListener('mousedown', e=>{ jump(); });
tapBtn.addEventListener('click', ()=> jump());

// ----- Collision -----
function circleRectCollision(cx,cy,r, rx,ry,rw,rh){ // approximate
  const closestX = Math.max(rx, Math.min(cx, rx+rw));
  const closestY = Math.max(ry, Math.min(cy, ry+rh));
  const dx = cx - closestX; const dy = cy - closestY;
  return (dx*dx + dy*dy) <= r*r;
}

// ----- Game loop -----
function update(){ if(!running) return; if(!player.alive) return;
  // spawn obstacles
  obstacleTimer++; if(obstacleTimer>obstacleInterval){ obstacleTimer=0; spawnObstacle(); obstacleInterval = 80 + Math.floor(Math.random()*140); }

  // physics
  player.vy += gravity; player.y += player.vy;
  if(player.y + player.r > groundY){ player.y = groundY - player.r; player.vy = 0; player.onGround = true; }

  // fall death
  if(player.y - player.r > H){ die('Падение'); }

  // move obstacles
  for(let i=obstacles.length-1;i>=0;i--){ const o=obstacles[i]; o.x -= o.speed; if(o.x + o.w < -50) obstacles.splice(i,1); else{
      if(circleRectCollision(player.x, player.y, player.r, o.x, o.y, o.w, o.h)){ die('Столкновение'); }
    }
  }
}

function die(reason){ if(!player.alive) return; player.alive=false; lives = Math.max(0, lives-1); updateHUD(); playBeep(); running=false; showDeath(reason); saveState(); }

function showDeath(reason){ // overlay
  ctx.fillStyle='rgba(0,0,0,0.45)'; ctx.fillRect(0,0,W,H);
  ctx.fillStyle='white'; ctx.font='28px Arial'; ctx.textAlign='center'; ctx.fillText('Вы умерли — '+reason, W/2, H/2 - 10);
  ctx.font='16px Arial'; ctx.fillText('Нажмите «Перезапустить» чтобы начать заново', W/2, H/2 + 20);
}

function draw(){ // clear
  ctx.clearRect(0,0,W,H);
  // ground
  ctx.fillStyle='#08321f'; ctx.fillRect(0,groundY, W, H-groundY);

  // player
  const skin = skins.find(s=>s.id===selectedSkin) || skins[0];
  ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.closePath();
  ctx.fillStyle = skin.color; ctx.fill();
  // outline
  ctx.lineWidth=2; ctx.strokeStyle='rgba(0,0,0,0.25)'; ctx.stroke();

  // obstacles
  for(const o of obstacles){ ctx.fillStyle='#6e2f2f'; ctx.fillRect(o.x, o.y, o.w, o.h); ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.strokeRect(o.x,o.y,o.w,o.h); }

  // score / tip
  ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fillRect(W-170,12,156,42);
  ctx.fillStyle='var(--accent)'; ctx.font='14px Arial'; ctx.textAlign='left'; ctx.fillText('Прыжков: '+score, W-160, 34);
}

// main loop
function loop(){ update(); draw(); if(running && player.alive){ requestAnimationFrame(loop); } }

// restart
restartBtn.addEventListener('click', ()=>{ resetGame(); loop(); });

// shop
shopBtn.addEventListener('click', ()=>{ renderShop(); shopModal.style.display='flex'; }); closeShop.addEventListener('click', ()=>{ shopModal.style.display='none'; });

function renderShop(){ skinsList.innerHTML=''; for(const s of skins){ const div = document.createElement('div'); div.className='skin'; const sw = document.createElement('div'); sw.className='swatch'; sw.style.background = s.color; div.appendChild(sw);
    const name = document.createElement('div'); name.innerHTML = `<strong>${s.name}</strong><div style="font-size:12px;color:var(--muted)">${s.cost>0?s.cost+' монет':''}</div>`; div.appendChild(name);
    const btn = document.createElement('button'); btn.className='btn'; if(ownedSkins.includes(s.id)){ btn.textContent = s.id===selectedSkin? 'Выбрано':'Выбрать'; btn.onclick = ()=>{ selectedSkin = s.id; saveState(); updateHUD(); renderShop(); }; } else { btn.textContent = 'Купить'; btn.onclick = ()=>{ if(coins>=s.cost){ coins-=s.cost; ownedSkins.push(s.id); selectedSkin = s.id; saveState(); updateHUD(); renderShop(); } else { alert('Недостаточно монет'); } } }
    div.appendChild(btn); skinsList.appendChild(div);
  }
}

// mute
muteBtn.addEventListener('click', ()=>{ soundOn = !soundOn; muteBtn.textContent = soundOn? 'Звук: вкл' : 'Звук: выкл'; });

// resize handling
window.addEventListener('resize', ()=>{
  const rect = canvas.getBoundingClientRect(); W = canvas.width = rect.width; H = canvas.height = rect.height; groundY = H - 60; if(player.y>groundY) player.y = groundY - player.r;
});

// initial setup
updateHUD(); renderShop(); loop();

// Save coins on unload
window.addEventListener('beforeunload', ()=> saveState());

</script>
</body>
</html>
